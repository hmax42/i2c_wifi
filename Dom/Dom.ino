/*
   M5Atom-Hydra

   Hardware-Compatibility

   ^----------------------------------------------------------------------------------------------^
   |  Hardware                     | Dom | Sub | I2C | ESP-now | Notes                            |
   |  Atom Lite                    |  x  |  x  |  x  |    ?    |                                  |
   |  Core                         |  x  |  ?  |  x  |    ?    | GPSv2 both variants              |
   |  Atom (Lite) Matrix           |  ?  |  x! |  x  |    ?    | why u no work                    |
   |  Atom (Lite) Echo             |  -  |  ?  |  ?  |    x    | i2s conflicts spi & gps serial   |
   |  Atom S3 (Lite) Oled          |  x  |  ?  | +/- |    ?    |                                  |
   |  Atom S3 Lite                 |  x  |  ?  | +/- |    x    |                                  |
   |  Stamp (Mate)                 |  ?  |  x  |  -  |    x    |                                  |
   |  Stamp (C3)                   |  ?  |  ?  |  ?  |    x    |                                  |
   |  Stamp (S3)                   |  ?  |  ?  |  ?  |    ?    |                                  |
   |  Atom C6                      |  ?  |  ?  |  ?  |    ?    |                                  |
   |                               |     |     |     |         |                                  |
   °----------------------------------------------------------------------------------------------°

  all RiSC-V not working as i2c slave, as well as pico.
  all of these do not expose the default i2c via the grove connector, except the stamps3
  atoms3lite:check m5stack profile and ESP32 profile
  i2c request is received and data is "sent" but received as garbage at dom (freq 100k and 400k)

  disable usb cdc for logging on serial usb (c3)

*/
//if no sd, do not abort setup, but skip gps and directly start espnow
//
//     Testmode | SD found | wait for GPS fix
//        true       true      false
//        true       false     false
//        false      true      true
//        false      false     true
//
//

//#define TESTMODE

// CHOOSE COMMUNICATION
#define COMM_I2C
//#define COMM_NOW

// CHOOSE WEBSERVER
//#define DomServer

// CHOOSE HARDWARE
#define S3OLED
//#define S3LITE
//#define ATOMLITE
//#define COREFIRE

//#define S3CAR
#define S3PORTA

//Extras
//conflicts with comm_I2c
//#define MiniOLED

#include <WiFi.h>
#ifdef DomServer
#include <WebServer.h>
#ifdef S3LITE
#ifdef MiniOLED
#define DOM_SSID "MiniHydra"
#define DOM_PASS "12345678"
#else
#define DOM_SSID "PicoHydra"
#define DOM_PASS "12345678"
#endif
#else
#ifdef S3OLED
#define DOM_SSID "OledHydra"
#define DOM_PASS "12345678"
#else
#ifdef COREFIRE
#define DOM_SSID "CoreHydra"
#define DOM_PASS "12345678"
#endif
#endif
#endif
#endif

#ifdef COMM_NOW
#define FILEPREFIX "espnow-"
#include <esp_now.h>
//how often to send the msg to subs to start scanning (in case a sub reboots or is rebooted)
//1 min = 60000
#define BROADCASTINTERVALL 60000
#endif

#ifdef COMM_I2C
  #ifdef S3LITE
    #define FILEPREFIX "car-i2c-"
  #else
    #ifdef S3OLED
      #ifdef S3PORTA
        #define FILEPREFIX "porta-i2c-"
      #else
        #ifdef S3CAR
          #define FILEPREFIX "car-i2c-"
        #endif
      #endif
    #else
      #ifdef COREFIRE
        #define FILEPREFIX "core-i2c-"
      #endif
    #endif
  #endif
#endif


#include <Wire.h>

#if defined(COMM_I2C) || defined(MiniOLED)
#include <Wire.h>
#endif
#ifdef MiniOLED
#include "SSD1306Wire.h"
#endif
#if defined(MiniOLED) || defined(S3OLED)
//72x42
const unsigned char hydra [] PROGMEM = {
  0x00, 0x00, 0x00, 0x00, 0x3e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7e, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0xff, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0xff,
  0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf0, 0xff, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0xf8, 0xff, 0x1f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xff, 0x1f, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0xf8, 0xff, 0x1f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xff, 0x1f, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0xf0, 0xff, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x20, 0x3e, 0x06,
  0xf8, 0x00, 0x00, 0x00, 0x80, 0x3b, 0x20, 0x18, 0x06, 0xdc, 0x01, 0x00, 0x00, 0xc0, 0x79, 0x20,
  0x18, 0x06, 0x8e, 0x01, 0x00, 0x00, 0xc0, 0xe0, 0xc0, 0xff, 0x01, 0x07, 0x01, 0x00, 0x00, 0xc0,
  0xc3, 0xe0, 0xff, 0x03, 0xe3, 0x01, 0x00, 0x00, 0xc0, 0xc7, 0xe0, 0xff, 0x07, 0xe1, 0x01, 0x00,
  0x00, 0x00, 0xc0, 0x00, 0xff, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x00, 0x7f, 0x80, 0x01,
  0x00, 0x00, 0x00, 0x00, 0xc0, 0x01, 0x3e, 0xc0, 0x01, 0x00, 0x00, 0x00, 0x00, 0x80, 0x0f, 0x00,
  0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x00, 0x78, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x3f, 0xe0, 0x00, 0x03, 0xfc, 0x01, 0x00, 0x00,
  0xc0, 0x3f, 0xf0, 0x00, 0x07, 0xfe, 0x03, 0x00, 0x00, 0xe0, 0xf0, 0xfc, 0x00, 0x3f, 0x07, 0x07,
  0x00, 0x00, 0x70, 0xe0, 0x7e, 0x00, 0xff, 0x03, 0x0f, 0x00, 0x00, 0x38, 0xc0, 0x07, 0x26, 0xe0,
  0x01, 0x1e, 0x00, 0x00, 0x18, 0x00, 0x00, 0x67, 0x00, 0x00, 0x18, 0x00, 0x00, 0x18, 0x00, 0x80,
  0xe7, 0x00, 0x00, 0x18, 0x00, 0x00, 0x18, 0x06, 0xc0, 0xe7, 0x01, 0x20, 0x18, 0x00, 0x00, 0x38,
  0x06, 0xf0, 0x80, 0x0f, 0x20, 0x1c, 0x00, 0x00, 0x38, 0x06, 0xf8, 0x00, 0x1f, 0x20, 0x0e, 0x00,
  0x00, 0xf0, 0x01, 0x1f, 0x00, 0xf8, 0xc0, 0x07, 0x00, 0x00, 0xe0, 0x81, 0x0f, 0x00, 0xf0, 0x80,
  0x03, 0x00, 0x00, 0x00, 0xc0, 0x01, 0x00, 0xc0, 0x01, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x00, 0x00,
  0x80, 0x01, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x80, 0x01, 0x00, 0x00, 0x00, 0x00, 0xc0,
  0xc1, 0x00, 0xc1, 0x01, 0x00, 0x00, 0x00, 0x00, 0x80, 0x3f, 0x00, 0xfe, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x3f, 0x00, 0xfe, 0x00, 0x00, 0x00
};
#endif
#ifdef S3OLED
//128x128
const unsigned char hydralarge [] PROGMEM = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfc, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfc, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfc, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xff, 0xff, 0x1f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfc, 0xff, 0xff, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0xff, 0xff, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0xff, 0xff, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xff, 0xff, 0xff, 0xff, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0xff, 0xff, 0xff, 0xff, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0xff, 0xff, 0xff, 0xff, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0xff, 0xff, 0xff, 0xff, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xff, 0xff, 0xff, 0xff, 0x1f, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0xfc, 0xff, 0xff, 0xff, 0xff, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0xff, 0xff, 0xff, 0xff, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0xff, 0xff, 0xff, 0xff, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0xff, 0xff, 0xff, 0xff, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0xff, 0xff, 0xff, 0xff, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0xff, 0xff, 0xff, 0xff, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0xff, 0xff, 0xff, 0xff, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0xff, 0xff, 0xff, 0xff, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0xff, 0xff, 0xff, 0xff, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0xff, 0xff, 0xff, 0xff, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0xfc, 0xff, 0xff, 0xff, 0xff, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xff, 0xff, 0xff, 0xff, 0x1f, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0xe0, 0xff, 0x00, 0x00, 0xf0, 0x07, 0xfe, 0x7f, 0xe0, 0x0f, 0x00, 0x00, 0xff, 0x07, 0x00,
  0x00, 0xe0, 0xff, 0x01, 0x00, 0xe0, 0x03, 0xfc, 0x3f, 0xc0, 0x07, 0x00, 0x80, 0xff, 0x07, 0x00,
  0x00, 0xf0, 0xff, 0x01, 0x00, 0xe0, 0x03, 0xfc, 0x3f, 0xc0, 0x07, 0x00, 0x80, 0xff, 0x0f, 0x00,
  0x00, 0xf8, 0xff, 0x03, 0x00, 0xe0, 0x03, 0xf8, 0x1f, 0xc0, 0x07, 0x00, 0xc0, 0xff, 0x1f, 0x00,
  0x00, 0xfe, 0xfb, 0x0f, 0x00, 0xe0, 0x03, 0xe0, 0x07, 0xc0, 0x07, 0x00, 0xf0, 0xdf, 0x7f, 0x00,
  0x00, 0xfe, 0xf1, 0x1f, 0x00, 0xe0, 0x03, 0xc0, 0x03, 0xc0, 0x07, 0x00, 0xf8, 0x8f, 0x7f, 0x00,
  0x00, 0xff, 0xe0, 0x1f, 0x00, 0xc0, 0x03, 0xc0, 0x03, 0xc0, 0x03, 0x00, 0xf8, 0x07, 0xff, 0x00,
  0x00, 0x7f, 0xc0, 0x3f, 0x00, 0x80, 0x03, 0xe0, 0x07, 0xc0, 0x01, 0x00, 0xfc, 0x03, 0xfe, 0x00,
  0x00, 0x3f, 0x80, 0xff, 0x00, 0x00, 0xfe, 0xff, 0xff, 0x7f, 0x00, 0x00, 0xff, 0x01, 0xfc, 0x00,
  0x00, 0x1f, 0x00, 0xff, 0x01, 0x00, 0xfc, 0xff, 0xff, 0x3f, 0x00, 0x80, 0xff, 0x00, 0xf8, 0x00,
  0x00, 0x1f, 0x00, 0xfe, 0x01, 0x00, 0xfe, 0xff, 0xff, 0x7f, 0x00, 0x80, 0x7f, 0x00, 0xf8, 0x00,
  0x00, 0x1f, 0x00, 0xfc, 0x01, 0x00, 0xff, 0xff, 0xff, 0xff, 0x00, 0x80, 0x3f, 0x00, 0xf8, 0x00,
  0x00, 0xff, 0x07, 0xf8, 0x01, 0x80, 0xff, 0xff, 0xff, 0xff, 0x01, 0x80, 0x1f, 0xe0, 0xff, 0x00,
  0x00, 0xff, 0x0f, 0xf0, 0x01, 0xc0, 0xff, 0xff, 0xff, 0xff, 0x03, 0x80, 0x0f, 0xf0, 0xff, 0x00,
  0x00, 0xff, 0x1f, 0xe0, 0x01, 0xc0, 0xff, 0xff, 0xff, 0xff, 0x03, 0x80, 0x07, 0xf8, 0xff, 0x00,
  0x00, 0xfe, 0x0f, 0xe0, 0x01, 0xc0, 0xff, 0xff, 0xff, 0xff, 0x03, 0x80, 0x07, 0xf0, 0x7f, 0x00,
  0x00, 0x00, 0x00, 0xe0, 0x01, 0x00, 0xf0, 0xff, 0xff, 0x0f, 0x00, 0x80, 0x07, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0xe0, 0x01, 0x00, 0xe0, 0xff, 0xff, 0x07, 0x00, 0x80, 0x07, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0xe0, 0x01, 0x00, 0xc0, 0xff, 0xff, 0x03, 0x00, 0x80, 0x07, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0xe0, 0x03, 0x00, 0xc0, 0xff, 0xff, 0x03, 0x00, 0xc0, 0x07, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0xe0, 0x07, 0x00, 0x00, 0xff, 0xff, 0x00, 0x00, 0xe0, 0x07, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0xe0, 0x1f, 0x00, 0x00, 0xfe, 0x7f, 0x00, 0x00, 0xf8, 0x07, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0xe0, 0x1f, 0x00, 0x00, 0xfc, 0x3f, 0x00, 0x00, 0xf8, 0x07, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0xc0, 0x3f, 0x00, 0x00, 0xfc, 0x3f, 0x00, 0x00, 0xfc, 0x03, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x80, 0x7f, 0x00, 0x00, 0xf0, 0x0f, 0x00, 0x00, 0xfe, 0x01, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0xff, 0x1f, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xff, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0xfe, 0x1f, 0x00, 0x00, 0x00, 0x00, 0xf8, 0x7f, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0xfc, 0x1f, 0x00, 0x00, 0x00, 0x00, 0xf8, 0x3f, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0xf8, 0x0f, 0x00, 0x00, 0x00, 0x00, 0xf0, 0x1f, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0xfe, 0xff, 0x0f, 0x00, 0xc0, 0x3f, 0x00, 0x00, 0xf8, 0x03, 0x00, 0xf0, 0xff, 0x7f, 0x00,
  0x00, 0xff, 0xff, 0x1f, 0x00, 0xc0, 0x3f, 0x00, 0x00, 0xf8, 0x03, 0x00, 0xf8, 0xff, 0xff, 0x00,
  0x00, 0xff, 0xff, 0x1f, 0x00, 0xe0, 0x3f, 0x00, 0x00, 0xfc, 0x07, 0x00, 0xf8, 0xff, 0xff, 0x00,
  0x80, 0xff, 0xff, 0x3f, 0x00, 0xf0, 0x3f, 0x00, 0x00, 0xfc, 0x0f, 0x00, 0xfc, 0xff, 0xff, 0x01,
  0xe0, 0x3f, 0x00, 0xff, 0xc0, 0xff, 0x3f, 0x00, 0x00, 0xfc, 0xff, 0x03, 0xff, 0x00, 0xfc, 0x07,
  0xf0, 0x1f, 0x00, 0xff, 0xe1, 0xff, 0x3f, 0x00, 0x00, 0xfc, 0xff, 0x87, 0xff, 0x00, 0xf8, 0x0f,
  0xf0, 0x0f, 0x00, 0xfe, 0xe1, 0xff, 0x1f, 0x00, 0x00, 0xf8, 0xff, 0x87, 0x7f, 0x00, 0xf0, 0x0f,
  0xf8, 0x07, 0x00, 0xfc, 0xf3, 0xff, 0x1f, 0x00, 0x00, 0xf8, 0xff, 0xcf, 0x3f, 0x00, 0xe0, 0x1f,
  0xff, 0x03, 0x00, 0xf0, 0xff, 0x07, 0x00, 0x18, 0x18, 0x00, 0xe0, 0xff, 0x0f, 0x00, 0xc0, 0xff,
  0xff, 0x01, 0x00, 0xe0, 0xff, 0x03, 0x00, 0x3c, 0x3c, 0x00, 0xc0, 0xff, 0x07, 0x00, 0x80, 0xff,
  0xff, 0x00, 0x00, 0xe0, 0xff, 0x01, 0x00, 0x3c, 0x3c, 0x00, 0x80, 0xff, 0x07, 0x00, 0x00, 0xff,
  0x7f, 0x00, 0x00, 0xc0, 0xff, 0x00, 0x00, 0x3e, 0x7c, 0x00, 0x00, 0xff, 0x03, 0x00, 0x00, 0xfe,
  0x3f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x3f, 0xfc, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfc,
  0x1f, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x3f, 0xfc, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8,
  0x0f, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x3f, 0xfc, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf0,
  0x0f, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0x3f, 0xfc, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf0,
  0x0f, 0x00, 0x04, 0x00, 0x00, 0x00, 0xf8, 0x3f, 0xfc, 0x1f, 0x00, 0x00, 0x00, 0x20, 0x00, 0xf0,
  0x0f, 0x00, 0x0e, 0x00, 0x00, 0x00, 0xfc, 0x3f, 0xfc, 0x3f, 0x00, 0x00, 0x00, 0x70, 0x00, 0xf0,
  0x0f, 0x00, 0x1f, 0x00, 0x00, 0x00, 0xfe, 0x3f, 0xfc, 0x7f, 0x00, 0x00, 0x00, 0xf8, 0x00, 0xf0,
  0x1f, 0x00, 0x1f, 0x00, 0x00, 0x00, 0xfe, 0x1f, 0xf8, 0x7f, 0x00, 0x00, 0x00, 0xf8, 0x00, 0xf8,
  0x3f, 0x00, 0x1f, 0x00, 0x00, 0xf8, 0xff, 0x00, 0x00, 0xff, 0x1f, 0x00, 0x00, 0xf8, 0x00, 0xfc,
  0xff, 0x00, 0x1f, 0x00, 0x00, 0xfc, 0x3f, 0x00, 0x00, 0xfc, 0x3f, 0x00, 0x00, 0xf8, 0x00, 0xff,
  0xff, 0x00, 0x1f, 0x00, 0x00, 0xfe, 0x3f, 0x00, 0x00, 0xfc, 0x7f, 0x00, 0x00, 0xf8, 0x00, 0xff,
  0xff, 0x01, 0x0f, 0x00, 0x00, 0xfe, 0x1f, 0x00, 0x00, 0xf8, 0x7f, 0x00, 0x00, 0xf0, 0x80, 0xff,
  0xff, 0x03, 0x07, 0x00, 0x80, 0xff, 0x0f, 0x00, 0x00, 0xf0, 0xff, 0x01, 0x00, 0xe0, 0xc0, 0xff,
  0xf8, 0xff, 0x01, 0x00, 0xfc, 0x3f, 0x00, 0x00, 0x00, 0x00, 0xfc, 0x3f, 0x00, 0x80, 0xff, 0x1f,
  0xf0, 0xff, 0x01, 0x00, 0xfe, 0x3f, 0x00, 0x00, 0x00, 0x00, 0xfc, 0x7f, 0x00, 0x80, 0xff, 0x0f,
  0xe0, 0xff, 0x00, 0x00, 0xff, 0x1f, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xff, 0x00, 0x00, 0xff, 0x07,
  0xc0, 0x7f, 0x00, 0x80, 0xff, 0x0f, 0x00, 0x00, 0x00, 0x00, 0xf0, 0xff, 0x01, 0x00, 0xfe, 0x03,
  0x00, 0x00, 0x00, 0xc0, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfc, 0x03, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0xe0, 0x1f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0x07, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0xe0, 0x1f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0x07, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0xe0, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf0, 0x07, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0xe0, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x07, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0xe0, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x07, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0xe0, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x07, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0xe0, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x07, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0xe0, 0x0f, 0x00, 0x08, 0x00, 0x00, 0x10, 0x00, 0xf0, 0x07, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0xe0, 0x1f, 0x00, 0x1c, 0x00, 0x00, 0x38, 0x00, 0xf8, 0x07, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0xe0, 0x1f, 0x00, 0x1c, 0x00, 0x00, 0x38, 0x00, 0xf8, 0x07, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0xc0, 0x3f, 0x00, 0x1e, 0x00, 0x00, 0x78, 0x00, 0xfc, 0x03, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0x03, 0x00, 0x00, 0xc0, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0xfe, 0xff, 0x03, 0x00, 0x00, 0xc0, 0xff, 0x7f, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0xfe, 0xff, 0x03, 0x00, 0x00, 0xc0, 0xff, 0x7f, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0xfe, 0xff, 0x03, 0x00, 0x00, 0xc0, 0xff, 0x7f, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};
#endif


#include <SPI.h>
#include <SD.h>
#include <TinyGPS++.h>

#ifdef S3OLED
#define S3
int const blinkSize = 10;
int const centerText = 3;
bool fileInit = false;
#define DISPLAYTIME 15000
#endif

#ifdef S3LITE
#define S3
#define LITE
const int LED_PIN = 35;
#endif

#ifdef ATOMLITE
#define LITE
#define SUB_SDA 26
#define SUB_SCL 32
#define GPS_RX 22
#define SD_CLK 23
#define SD_MISO 33
#define SD_MOSI 19
#define BTN 39
#define GPSSERIAL Serial1
const int LED_PIN = 27;
#endif


#ifdef S3
#define SUB_SDA 2
#define SUB_SCL 1
#define GPS_RX 5
#define SD_CLK 7
#define SD_MISO 8
#define SD_MOSI 6
#define BTN 41
#define GPSSERIAL Serial2
#include <M5AtomS3.h>
#endif

#ifdef COREFIRE
#define WHITE 0xFFFF
#define BLACK 0x0000
#endif

#if defined(S3OLED) || defined(COREFIRE)
int fg = WHITE;
int bg = BLACK;
#endif

#ifdef COREFIRE
#include <M5Stack.h>
#define SUB_SDA 21
#define SUB_SCL 22
#define GPS_RX 16
#define SD_CLK 18
#define SD_MISO 19
#define SD_MOSI 23
#define SD_CS 4
#define BTN 39
#define GPSSERIAL Serial2
#define GPSBAUD 115200
const int LED_PIN = //15;
  26; //ext? PORT B
#define LITE

#define DISPLAYTIME 2500

#endif

#ifdef LITE
#include <FastLED.h>
CRGB led;
#endif

#ifndef SD_CS
#define SD_CS -1
#endif

#ifndef GPSBAUD
#define GPSBAUD 9600
#endif

TinyGPSPlus gps;
#ifdef DomServer
WebServer server(80);
#endif
File dataFile;
String fileName;

#ifdef DomServer
const char* ssid = DOM_SSID;
const char* password = DOM_PASS;
#endif

#ifdef COMM_I2C
const int i2c_slave_address = 0x55;
#define TCAADDR 0x70
#endif

#define NUM_PORTS 8 //2 //6
#if defined(S3OLED) || defined(MiniOLED) || defined(COREFIRE)
bool oled = true;
#endif


struct NetworkInfo {
  char ssid[32];
  char bssid[18];
  int32_t rssi;
  char security[20];
  uint8_t channel;
  char type;
#ifdef COMM_NOW
  int boardId;
#endif
};

NetworkInfo receivedNetworks[NUM_PORTS];

#ifdef COMM_NOW
uint8_t broadcastAddress[] = {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF};
esp_now_peer_info_t peerInfo;
long lastBroadcastMillis = -1;
NetworkInfo myData;
uint8_t dummy = 0;
#endif

#ifdef DomServer
int totalNetworksSent[NUM_PORTS] = { 0 };
#endif

#ifdef MiniOLED
const int oled_i2c_slave_address = 0x3c;
SSD1306Wire  display(oled_i2c_slave_address, SUB_SDA , SUB_SCL);
int x = 28;
//int y = 24; //vertically "flipped"
int y = 0;
int currentChannelOled = 0;
#define DISPLAYTIME 1500
#endif
#if defined(S3OLED)
int x = 0;
int y = 0;
#endif

#if defined(S3OLED) || defined(MiniOLED) || defined(COREFIRE)
// 0 is BLE
int countNetworks[15] = {0};
#endif


void processButton();
void waitForGPSFix();
void initializeFile();
#ifdef COMM_NOW
void OnDataRecv(const uint8_t* mac, const uint8_t* incomingData, int len);
void OnDataSent(const uint8_t* mac_addr, esp_now_send_status_t status);
void sendSubMsg();
#endif
#ifdef DomServer
void handleRoot();
void handleData();
#endif
#ifdef COMM_I2C
void tcaselect(uint8_t i);
bool requestNetworkData(uint8_t port);
void drawFileStatus();
void drawStatus(bool active, char letter, int dx, int text);
#endif
#if defined(S3OLED) || defined(MiniOLED) || defined(COREFIRE)
void draw(bool update);
void updateScreen();
void draw();
#endif
void blinkLEDWhite();
void blinkLEDRed();
void blinkLEDGreen();
void blinkLEDPurple();
void blinkLED();



void setup() {

#ifdef S3OLED
  auto cfg = M5.config();
  AtomS3.begin(cfg);
  //  AtomS3.Display.setTextFont(&fonts::TomThumb);
  //  AtomS3.Display.setTextSize(2);
  AtomS3.Display.setTextFont(&fonts::FreeSerif9pt7b);
  AtomS3.Display.setTextSize(1);
  AtomS3.Display.fillScreen(bg);
  AtomS3.Display.setTextColor(fg);
  AtomS3.Display.setRotation(1); //porta
  AtomS3.Display.setRotation(3); //car

  AtomS3.Display.clear();
  AtomS3.Display.drawRect(x + 0, y + 0, 128, 128);
  AtomS3.Display.drawBitmap(x + 0, y + 0, hydralarge, 128, 128, WHITE);
  AtomS3.Display.display();
#endif
  Serial.begin(115200);

#ifdef LITE
  FastLED.addLeds<WS2812, LED_PIN, GRB>(&led, 1);
  led = CRGB::Black;
  FastLED.show();
#endif
#ifdef S3OLED
  drawGPSStatus();
  drawFileStatus();
#endif
#ifdef COREFIRE
  M5.begin();        // Init M5Core
  M5.Power.begin();  // Init Power module
  FastLED.setBrightness(40);
#endif
#ifdef DomServer
  WiFi.softAP(ssid, password);
  IPAddress IP = WiFi.softAPIP();
  Serial.println("AP IP Address: " + IP.toString());
  server.on("/", handleRoot);
  server.on("/data", handleData);
  server.begin();
#endif
#if defined(COMM_I2C) || defined(MiniOLED)
  Wire.begin(SUB_SDA , SUB_SCL, 400000);  // SDA, SCL
  Serial.println("[MASTER] I2C Master Initialized");
#endif
#ifdef MiniOLED
  display.init();

  //display.flipScreenVertically();
  //display.mirrorScreen();

  display.clear();
  display.setTextAlignment(TEXT_ALIGN_LEFT);
  display.drawRect(x + 0, y + 0, 72, 40);
  display.drawXbm(x + 0, y + 0, 72, 40, hydra);
  display.display();
#endif
  SPI.begin(SD_CLK, SD_MISO, SD_MOSI, -1);  // Initialize SPI for SD card
#ifdef COREFIRE
  if (!SD.begin(SD_CS)) {
#else
  if (!SD.begin()) {
#endif
    Serial.println("SD Card initialization failed!");
    unsigned long startMillis = millis();
    const unsigned long blinkInterval = 500;
    while (millis() - startMillis < 5000) {  // Continue blinking for 5 seconds
#if defined(S3OLED) || defined(MiniOLED) || defined(COREFIRE)
      processButton();
#endif
      //int      if (((millis() - startMillis) / blinkInterval) % 2  == 1 ) {
      blinkLEDRed();
    }
#ifdef COREFIRE
  } else {
#else
  } else {
#endif
    Serial.println("SD Card initialized.");
  }
#ifdef TESTMODE
  Serial.println("Starting without GPS fix and no proper file initialization.");
  return;
#endif

#ifndef TESTMODE
  GPSSERIAL.begin(GPSBAUD, SERIAL_8N1, GPS_RX, -1);  // GPS Serial
  waitForGPSFix();

  initializeFile();
  Serial.println("File created.");
#endif

#ifdef COMM_NOW
  WiFi.mode(WIFI_STA);

  if (esp_now_init() != 0) {
    Serial.println("Error initializing ESP-NOW");
    return;
  }

  esp_now_register_recv_cb(OnDataRecv);
  esp_now_register_send_cb(OnDataSent);
  Serial.println("[MASTER] ESP-NOW initialized");

  memcpy(peerInfo.peer_addr, broadcastAddress, 6);
  peerInfo.channel = 0;
  peerInfo.encrypt = false;

  // Add peer
  if (esp_now_add_peer(&peerInfo) != ESP_OK) {
    Serial.println("Failed to add peer");
    return;
  }

  // tell sub to start scanning
  sendSubMsg();
#endif
}


void loop() {
#if defined(S3OLED) || defined(MiniOLED) || defined(COREFIRE)
  processButton();
#endif
#ifdef DomServer
  server.handleClient();
#endif
#if defined(S3OLED) || defined(MiniOLED) || defined(COREFIRE)
  updateScreen();
#endif
  while (GPSSERIAL.available() > 0) {
    gps.encode(GPSSERIAL.read());
  }
#ifdef COMM_I2C
  for (uint8_t port = 0; port < NUM_PORTS; port++) {
    
    //extra button check for corefire
#if defined(S3OLED) || defined(MiniOLED) || defined(COREFIRE)
    processButton();
#endif
    //TEST for Stamps without switch
    tcaselect(port);
    blinkLEDWhite();
    if (requestNetworkData(port)) {
#ifdef DomServer
      totalNetworksSent[port]++;
#endif
#if defined(S3OLED) || defined(MiniOLED) || defined(COREFIRE)
      countNetworks[receivedNetworks[port].channel]++;
#endif
      logData(receivedNetworks[port], port);
    }
  }
#endif

#ifdef COMM_NOW
  //in case a sub rebooted
  long n = millis();
  if (n - lastBroadcastMillis > BROADCASTINTERVALL) {
    sendSubMsg();
  } else {
    //more possiblity to receive msgs
    delay(10);
  }
#endif
}
